#!/bin/bash

SERVER="57.128.42.40"
USER="tunnel"
SSH_PORT=22

BASE_DIR="$HOME/atherix-tunnel"
KEY_FILE="$BASE_DIR/id_ed25519"
MAP_DIR="$BASE_DIR/map"
LOG_DIR="$BASE_DIR/logs"

mkdir -p "$BASE_DIR" "$MAP_DIR" "$LOG_DIR"
chmod 700 "$BASE_DIR"

RED="\e[31m"; GRN="\e[32m"; YEL="\e[33m"; CYN="\e[36m"; RST="\e[0m"
BOLD="\e[1m"

# =============================
# بانر ترحيبي
# =============================
banner(){
clear
echo -e "${GRN}${BOLD}"
echo "██████╗ ██████╗"
echo "██║  ██║██║   ██║"
echo "███████║██║   ██║"
echo "██╔══██║██║   ██║"
echo "██║  ██║╚██████╔╝"
echo "╚═╝  ╚═╝ ╚═════╝"
echo -e "${RST}"
echo -e "${YEL}${BOLD}HYCREO DEV${RST}"
echo -e "${CYN}MADE BY MUSLIMON :)${RST}"
echo
for i in 1 2 3; do
    echo -ne "${GRN}WAIT"
    for j in $(seq 1 $i); do echo -ne "."; done
    echo -e "${RST}"
    sleep 0.5
done
echo
}

banner

# =============================
# وظائف التونل
# =============================
start_tunnel(){
port="$1"
log_file="$LOG_DIR/tunnel-$port.log"

echo -e "${GRN}Starting persistent tunnel for port $port...${RST}"

# Loop مستمر لكل بورت
while true; do
    if ! pgrep -f "ssh.*-R.*$port.*$SERVER" >/dev/null; then
        echo "[$(date)] Tunnel down. Restarting..." >> "$log_file"
        ssh -i "$KEY_FILE" -o StrictHostKeyChecking=no \
            -o ServerAliveInterval=30 -o ServerAliveCountMax=3 \
            -o ExitOnForwardFailure=yes \
            -N -R "$port:localhost:$port" "$USER@$SERVER" -p $SSH_PORT \
            >> "$log_file" 2>&1 &
        echo "$port" > "$MAP_DIR/$port.map"
        echo "[$(date)] Tunnel up at $SERVER:$port" >> "$log_file"
    fi
    sleep 5
done
}

start_range(){
start=$(echo "$1" | cut -d- -f1)
end=$(echo "$1" | cut -d- -f2)
for ((p=start; p<=end; p++)); do
    start_tunnel "$p" &
done
}

list_ports(){
echo
echo -e "${BOLD}Active tunnels:${RST}"
for f in "$MAP_DIR"/*.map; do
    [ -f "$f" ] || continue
    port=$(basename "$f" .map)
    echo -e "  - $SERVER:$port"
done
echo
}

# =============================
# واجهة تفاعلية تظهر مباشرة عند التشغيل
# =============================
while true; do
    echo
    echo "Select an option:"
    echo "1) See ports list"
    echo "2) Add ports"
    read -p "Choice: " choice

    case "$choice" in
        1) list_ports ;;
        2)
            read -p "First port (e.g., 1111): " first
            read -p "Last port (e.g., 8000): " last
            echo -e "${YEL}Wait....${RST}"
            start_range "$first-$last"
            echo -e "${GRN}Thx for using this tool!!${RST}"
            ;;
        *) echo "Invalid choice" ;;
    esac
done
