#!/bin/bash

SERVER="57.128.42.40"
USER="tunnel"
SSH_PORT=22

INSTALL_PATH="/usr/local/bin/tunnel"
SERVICE_PATH="/etc/systemd/system/tunnel@.service"

BASE_DIR="/etc/atherix-tunnel"
KEY_FILE="$BASE_DIR/id_ed25519"
MAP_DIR="$BASE_DIR/map"

RED="\e[31m"; GRN="\e[32m"; YEL="\e[33m"; CYN="\e[36m"; RST="\e[0m"
BOLD="\e[1m"

# ════════════════════════════════════════
# بانر الترحيب
# ════════════════════════════════════════
banner(){
    clear
    echo -e "${GRN}${BOLD}"
    echo "  ██╗  ██╗██╗   ██╗ ██████╗███████╗███████╗ ██████╗ ██████╗ "
    echo "  ██║  ██║██║   ██║██╔════╝██╔════╝██╔════╝██╔═══██╗██╔══██╗"
    echo "  ███████║██║   ██║██║     █████╗  █████╗  ██║   ██║██████╔╝"
    echo "  ██╔══██║██║   ██║██║     ██╔══╝  ██╔══╝  ██║   ██║██╔═══╝ "
    echo "  ██║  ██║╚██████╔╝╚██████╗███████╗███████╗╚██████╔╝██║     "
    echo "  ╚═╝  ╚═╝ ╚═════╝  ╚═════╝╚══════╝╚══════╝ ╚═════╝ ╚═╝     "
    echo -e "${RST}"
    echo -e "${YEL}${BOLD}HYCREO DEV${RST}"
    echo -e "${CYN}MADE BY MUSLIMON :)${RST}"
    echo
    for i in 1 2 3; do
        echo -ne "${GRN}WAIT"
        for j in $(seq 1 $i); do echo -ne "."; done
        echo -e "${RST}"
        sleep 0.5
    done
    echo
}

banner

# ════════════════════════════════════════
# تثبيت systemd
# ════════════════════════════════════════
install_tool() {
    if [ "$EUID" -ne 0 ]; then
        echo -e "${RED}Run as root${RST}"
        exit 1
    fi

    mkdir -p "$BASE_DIR" "$MAP_DIR"
    chmod 700 "$BASE_DIR"

    cp "$0" "$INSTALL_PATH"
    chmod +x "$INSTALL_PATH"

    cat > "$SERVICE_PATH" <<EOF
[Unit]
Description=Persistent SSH Tunnel %i
After=network.target

[Service]
ExecStart=/usr/bin/ssh -i $KEY_FILE -o StrictHostKeyChecking=no -o ServerAliveInterval=30 -o ServerAliveCountMax=3 -o ExitOnForwardFailure=yes -N -R %i:localhost:%i $USER@$SERVER -p $SSH_PORT
Restart=always
RestartSec=5

[Install]
WantedBy=multi-user.target
EOF

    systemctl daemon-reload
    echo -e "${GRN}Installed successfully.${RST}"
    echo "Command available: tunnel"
    exit 0
}

# ════════════════════════════════════════
# وظائف التونل
# ════════════════════════════════════════
start_port() {
    port="$1"
    if ! [[ "$port" =~ ^[0-9]+$ ]] || [ "$port" -lt 1 ] || [ "$port" -gt 65535 ]; then
        echo -e "${RED}Invalid port${RST}"
        return 1
    fi

    systemctl enable tunnel@$port
    systemctl restart tunnel@$port
    echo "$port" > "$MAP_DIR/$port.map"
    echo -e "${GRN}Active 24/7: $SERVER:$port${RST}"
}

start_range() {
    start=$(echo "$1" | cut -d- -f1)
    end=$(echo "$1" | cut -d- -f2)
    for ((p=start; p<=end; p++)); do
        start_port "$p"
    done
}

list_ports(){
    echo
    echo -e "${BOLD}Current active ports:${RST}"
    for f in "$MAP_DIR"/*.map; do
        [ -f "$f" ] || continue
        port=$(basename "$f" .map)
        echo -e "  - $SERVER:$port"
    done
    echo
}

# ════════════════════════════════════════
# القائمة التفاعلية
# ════════════════════════════════════════
interactive_menu(){
    echo "Select an option:"
    echo "1) See ports"
    echo "2) Add ports"
    read -p "Choice: " choice

    case "$choice" in
        1)
            list_ports
            ;;
        2)
            read -p "First port: " first
            read -p "Last port: " last
            echo -e "${YEL}Wait....${RST}"
            sleep 1
            start_range "$first-$last"
            echo -e "${GRN}Thx for using this tool!!${RST}"
            ;;
        *)
            echo "Invalid choice"
            ;;
    esac
}

# ════════════════════════════════════════
# معالجة الأوامر
# ════════════════════════════════════════
if [[ "$1" == "--install" ]]; then
    install_tool
    exit 0
fi

case "$1" in
custom)
    if [[ "$2" == *"-"* ]]; then
        start_range "$2"
    else
        start_port "$2"
    fi
    ;;
get)
    port="$2"
    if [ -f "$MAP_DIR/$port.map" ]; then
        echo -e "${GRN}$SERVER:$port${RST}"
    else
        echo -e "${RED}Not active${RST}"
    fi
    ;;
interactive|"")
    interactive_menu
    ;;
*)
    echo
    echo "Usage:"
    echo "tunnel custom <port>"
    echo "tunnel custom 3000-8000"
    echo "tunnel get <port>"
    echo "tunnel interactive   # menu to add/view ports"
    echo
    ;;
esac
